name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  OPENROUTER_API_URL: https://91vip.futureppo.top/v1/chat/completions
  OPENROUTER_MODEL: "copilot/gemini-3-flash-preview"
  GITHUB_OWNER: "TBedu"
  GITHUB_REPO: "FastCode"

jobs:
  # 验证版本号格式
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Validate semantic version
        id: check
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Checking tag: $TAG"
          
          # 语义化版本正则表达式
          SEMVER_REGEX="^v(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?$"
          
          if [[ "$TAG" =~ $SEMVER_REGEX ]]; then
            echo "✅ Valid semantic version: $TAG"
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "version=$TAG" >> $GITHUB_OUTPUT
          else
            echo "❌ Invalid version format: $TAG"
            echo "Expected format: vX.Y.Z or vX.Y.Z-prerelease"
            echo "Examples: v1.0.0, v1.2.3-beta, v2.0.0-rc.1"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  build:
    name: Build for ${{ matrix.os }}-${{ matrix.arch }}
    needs: validate-version
    if: needs.validate-version.outputs.valid == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            goos: linux
            goarch: amd64
            compress: tar.gz
          - os: linux
            arch: arm64
            goos: linux
            goarch: arm64
            compress: tar.gz
          - os: linux
            arch: 386
            goos: linux
            goarch: 386
            compress: tar.gz
          - os: windows
            arch: amd64
            goos: windows
            goarch: amd64
            compress: zip
          - os: windows
            arch: 386
            goos: windows
            goarch: 386
            compress: zip
          - os: darwin
            arch: amd64
            goos: darwin
            goarch: amd64
            compress: tar.gz
          - os: darwin
            arch: arm64
            goos: darwin
            goarch: arm64
            compress: tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.20.0'

      - name: Extract version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          mkdir -p build
          go build -ldflags "-s -w -X main.version=${{ env.VERSION }} -X main.commit=${{ github.sha }}" -o build/fastcode${{ matrix.os == 'windows' && '.exe' || '' }}

      - name: Package application
        run: |
          mkdir -p package
          cp -r build/fastcode${{ matrix.os == 'windows' && '.exe' || '' }} package/
          cp -r public/ package/
          cd package
          if [ "${{ matrix.compress }}" = "zip" ]; then
            zip -r ../fastcode_${{ env.VERSION }}_${{ matrix.os }}_${{ matrix.arch }}.zip .
          else
            tar -czf ../fastcode_${{ env.VERSION }}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz .
          fi
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fastcode-${{ matrix.os }}-${{ matrix.arch }}
          path: fastcode_${{ env.VERSION }}_${{ matrix.os }}_${{ matrix.arch }}.${{ matrix.compress }}

  release:
    name: Create Release
    needs: [validate-version, build]
    if: needs.validate-version.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate release note via OpenRouter
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          OPENROUTER_API_URL: ${{ env.OPENROUTER_API_URL }}
          OPENROUTER_MODEL: ${{ env.OPENROUTER_MODEL }}
          GITHUB_OWNER: "TBedu"
          GITHUB_REPO: "FastCode"
        run: |
          set -euo pipefail

          # 当前 tag
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          echo "Current tag: $CURRENT_TAG"

          # 从 GitHub API 获取 tag 列表
          TAGS_JSON=$(curl -s "https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/tags?per_page=100")
          TAGS=( $(echo "$TAGS_JSON" | jq -r '.[].name' | sort -V) )

          # 找到上一个 tag
          PREV_TAG=""
          for i in "${!TAGS[@]}"; do
            if [ "${TAGS[$i]}" = "$CURRENT_TAG" ]; then
              if [ $i -gt 0 ]; then
                PREV_TAG="${TAGS[$((i-1))]}"
              fi
              break
            fi
          done

          if [ -z "$PREV_TAG" ]; then
            echo "⚠️ Could not find previous tag for $CURRENT_TAG, using first commit"
            PREV_TAG=$(git rev-list --max-parents=0 HEAD | head -1)
          fi

          echo "Previous tag: $PREV_TAG"

          # 强制拉取上一个 tag 和当前 tag
          git fetch origin "refs/tags/$PREV_TAG:refs/tags/$PREV_TAG" --force || true
          git fetch origin "refs/tags/$CURRENT_TAG:refs/tags/$CURRENT_TAG" --force || true

          # 获取 commit，使用更清晰的格式
          COMMITS=$(git log --pretty=format:'- %s (%h)' "$PREV_TAG".."$CURRENT_TAG" 2>/dev/null || git log --pretty=format:'- %s (%h)' -20)

          echo "Commit list from $PREV_TAG to $CURRENT_TAG:"
          echo "$COMMITS"

          # 获取文件变化统计
          echo "Getting file change statistics..."
          FILE_STATS=$(git diff --stat "$PREV_TAG".."$CURRENT_TAG" 2>/dev/null || echo "")
          
          # 获取总体统计（最后一行）
          SUMMARY_LINE=$(echo "$FILE_STATS" | tail -1)
          echo "Summary: $SUMMARY_LINE"
          
          # 获取每个文件的变化（去掉最后一行汇总）
          FILE_CHANGES=$(echo "$FILE_STATS" | head -n -1 | head -50 | cut -c1-80)
          
          # 如果文件变化太多，进一步精简：只保留主要目录的变化
          FILE_COUNT=$(echo "$FILE_STATS" | head -n -1 | wc -l)
          if [ "$FILE_COUNT" -gt 50 ]; then
            echo "Too many files ($FILE_COUNT), grouping by directory..."
            # 按目录分组统计
            DIR_STATS=$(git diff --stat "$PREV_TAG".."$CURRENT_TAG" 2>/dev/null | head -n -1 | \
              sed 's/|.*//g' | \
              awk -F'/' '{if(NF>1) print $1"/"$2; else print $1}' | \
              sort | uniq -c | sort -rn | head -20)
            FILE_CHANGES="[按目录分组统计 - 共 $FILE_COUNT 个文件变更]\n$DIR_STATS"
          fi
          
          echo "File changes:"
          echo "$FILE_CHANGES"

          # 获取具体代码变化（关键文件的diff）
          echo "Getting code diff for key files..."
          
          # 定义关键目录
          KEY_DIRS="main.go public/ .github/"
          
          # 获取变更的关键文件列表
          KEY_FILES=$(git diff --name-only "$PREV_TAG".."$CURRENT_TAG" 2>/dev/null | \
            grep -E "(main\.go|public/|\.github/)" || true | \
            head -15) || true
          
          CODE_DIFF=""
          DIFF_CHAR_LIMIT=6000  # 总diff字符限制
          CURRENT_CHARS=0
          
          if [ -n "$KEY_FILES" ]; then
            for file in $KEY_FILES; do
              if [ "$CURRENT_CHARS" -ge "$DIFF_CHAR_LIMIT" ]; then
                CODE_DIFF="$CODE_DIFF\n[... 更多文件变化已截断 ...]"
                break
              fi
              
              # 获取单个文件的diff，限制每个文件最多50行
              FILE_DIFF=$(git diff "$PREV_TAG".."$CURRENT_TAG" -- "$file" 2>/dev/null | head -50) || true
              FILE_DIFF_LEN=${#FILE_DIFF}
              
              # 如果单个文件diff超过1500字符，截断
              if [ "$FILE_DIFF_LEN" -gt 1500 ]; then
                FILE_DIFF=$(echo "$FILE_DIFF" | head -c 1500)
                FILE_DIFF="$FILE_DIFF\n[... 文件 $file 变化已截断 ...]"
              fi
              
              if [ -n "$FILE_DIFF" ]; then
                CODE_DIFF="$CODE_DIFF\n\n### $file\n\`\`\`diff\n$FILE_DIFF\n\`\`\`"
                CURRENT_CHARS=$((CURRENT_CHARS + FILE_DIFF_LEN))
              fi
            done
          fi
          
          # 如果没有关键文件变化，获取前5个变更文件的diff
          if [ -z "$CODE_DIFF" ]; then
            echo "No key files changed, getting top changed files..."
            TOP_FILES=$(git diff --name-only "$PREV_TAG".."$CURRENT_TAG" 2>/dev/null | \
              head -5) || true
            
            if [ -n "$TOP_FILES" ]; then
              for file in $TOP_FILES; do
                FILE_DIFF=$(git diff "$PREV_TAG".."$CURRENT_TAG" -- "$file" 2>/dev/null | head -30) || true
                if [ -n "$FILE_DIFF" ] && [ ${#FILE_DIFF} -lt 1000 ]; then
                  CODE_DIFF="$CODE_DIFF\n\n### $file\n\`\`\`diff\n$FILE_DIFF\n\`\`\`"
                fi
              done
            fi
          fi
          
          # 如果仍然没有代码变化，添加说明
          if [ -z "$CODE_DIFF" ]; then
            CODE_DIFF="[本次更新主要涉及配置文件和文档变更，无核心代码变化]"
          fi
          
          echo "Code diff preview:"
          echo "$CODE_DIFF" | head -50

          # 读取 prompt
          PROMPT_FILE=".github/prompt/release_note_prompt.txt"
          SYSTEM_PROMPT=$(<"$PROMPT_FILE")

          # 构建用户内容，传递更多上下文
          USER_CONTENT="当前版本: $CURRENT_TAG\n上一版本: $PREV_TAG\n\n## 提交列表\n$COMMITS\n\n## 文件变化统计\n$SUMMARY_LINE\n\n## 变更文件列表\n$FILE_CHANGES\n\n## 关键代码变化\n$CODE_DIFF"

          # 构建请求 JSON
          BODY=$(jq -n \
            --arg system "$SYSTEM_PROMPT" \
            --arg user "$USER_CONTENT" \
            --arg model "$OPENROUTER_MODEL" \
            '{model: $model, messages:[{role:"system", content:$system},{role:"user", content:$user}], temperature:0.2, max_tokens:1500}')

          echo "=== OpenRouter request body ==="
          echo "$BODY" | jq .

          # 调用 OpenRouter
          if RESPONSE=$(curl -s -X POST "$OPENROUTER_API_URL" \
            -H "Authorization: Bearer $OPENAI_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY"); then
            echo "=== OpenRouter response ==="
            if echo "$RESPONSE" | jq . >/dev/null 2>&1; then
              echo "$RESPONSE" | jq .
            else
              echo "jq failed to parse response"
            fi

            # 提取生成内容
            RELEASE_BODY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // .choices[0].text // ""' 2>/dev/null || echo "")

            if [ -z "$RELEASE_BODY" ]; then
              echo "❌ OpenRouter failed to generate release note, using default template"
              # 使用默认模板
              DEFAULT_TEMPLATE=".github/prompt/default.md"
              if [ -f "$DEFAULT_TEMPLATE" ]; then
                # 读取默认模板并替换变量
                cat "$DEFAULT_TEMPLATE" > CHANGELOG.md
                sed -i "s/\$CURRENT_TAG/$CURRENT_TAG/g" CHANGELOG.md
                sed -i "s/\$PREV_TAG/$PREV_TAG/g" CHANGELOG.md
              else
                echo "⚠️ Default template file not found, using minimal template"
                echo "# $CURRENT_TAG\n\n## 更新\n- 修复了一些问题\n- 优化了一些功能\n\n**完整更新日志**: [${PREV_TAG}...${CURRENT_TAG}](https://github.com/TBeduCN/FastCode/compare/${PREV_TAG}...${CURRENT_TAG})" > CHANGELOG.md
              fi
            else
              # 后处理：确保版本号正确，并添加比较链接
              echo -e "$RELEASE_BODY" > CHANGELOG.md
              # 替换可能的占位符
              sed -i "s/{VERSION}/$CURRENT_TAG/g" CHANGELOG.md
              sed -i "s/{PREV_VERSION}/$PREV_TAG/g" CHANGELOG.md
            fi
          else
            echo "❌ Curl failed, using default template"
            # 使用默认模板
            DEFAULT_TEMPLATE=".github/prompt/default.md"
            if [ -f "$DEFAULT_TEMPLATE" ]; then
              # 读取默认模板并替换变量
              cat "$DEFAULT_TEMPLATE" > CHANGELOG.md
              sed -i "s/\$CURRENT_TAG/$CURRENT_TAG/g" CHANGELOG.md
              sed -i "s/\$PREV_TAG/$PREV_TAG/g" CHANGELOG.md
            else
              echo "⚠️ Default template file not found, using minimal template"
              echo "# $CURRENT_TAG\n\n## 更新\n- 修复了一些问题\n- 优化了一些功能\n\n**完整更新日志**: [${PREV_TAG}...${CURRENT_TAG}](https://github.com/TBeduCN/FastCode/compare/${PREV_TAG}...${CURRENT_TAG})" > CHANGELOG.md
            fi
          fi
          echo "=== generated release note ==="
          cat CHANGELOG.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/fastcode_*
          body_path: CHANGELOG.md