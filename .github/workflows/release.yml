name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  GITHUB_OWNER: "TBedu"
  GITHUB_REPO: "FastCode"

jobs:
  # 验证版本号格式
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Validate semantic version
        id: check
        run:
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Checking tag: $TAG"
          
          # 语义化版本正则表达式
          SEMVER_REGEX="^v(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?$"
          
          if [[ "$TAG" =~ $SEMVER_REGEX ]]; then
            echo "✅ Valid semantic version: $TAG"
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "version=$TAG" >> $GITHUB_OUTPUT
          else
            echo "❌ Invalid version format: $TAG"
            echo "Expected format: vX.Y.Z or vX.Y.Z-prerelease"
            echo "Examples: v1.0.0, v1.2.3-beta, v2.0.0-rc.1"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  build:
    name: Build for ${{ matrix.os }}-${{ matrix.arch }}
    needs: validate-version
    if: needs.validate-version.outputs.valid == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            goos: linux
            goarch: amd64
            compress: tar.gz
          - os: linux
            arch: arm64
            goos: linux
            goarch: arm64
            compress: tar.gz
          - os: linux
            arch: 386
            goos: linux
            goarch: 386
            compress: tar.gz
          - os: windows
            arch: amd64
            goos: windows
            goarch: amd64
            compress: zip
          - os: windows
            arch: 386
            goos: windows
            goarch: 386
            compress: zip
          - os: darwin
            arch: amd64
            goos: darwin
            goarch: amd64
            compress: tar.gz
          - os: darwin
            arch: arm64
            goos: darwin
            goarch: arm64
            compress: tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.20.0'

      - name: Extract version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run:
          mkdir -p build
          go build -ldflags "-s -w -X main.version=${{ env.VERSION }} -X main.commit=${{ github.sha }}" -o build/fastcode${{ matrix.os == 'windows' && '.exe' || '' }}

      - name: Package application
        run:
          mkdir -p package
          cp build/fastcode${{ matrix.os == 'windows' && '.exe' || '' }} package/
          cd package
          if [ "${{ matrix.compress }}" = "zip" ]; then
            zip -r ../fastcode_${{ env.VERSION }}_${{ matrix.os }}_${{ matrix.arch }}.zip *
          else
            tar -czf ../fastcode_${{ env.VERSION }}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz *
          fi
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fastcode_${{ matrix.os }}_${{ matrix.arch }}
          path: fastcode_${{ env.VERSION }}_${{ matrix.os }}_${{ matrix.arch }}.${{ matrix.compress }}

  release:
    name: Create Release
    needs: [validate-version, build]
    if: needs.validate-version.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate release note using default template
        env:
          GITHUB_OWNER: "TBedu"
          GITHUB_REPO: "FastCode"
        run:
          set -euo pipefail

          # 当前 tag
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          echo "Current tag: $CURRENT_TAG"

          # 从 GitHub API 获取 tag 列表
          echo "Fetching tags from GitHub API..."
          TAGS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/tags?per_page=100")

          # 检查 API 响应是否有效
          if ! echo "$TAGS_JSON" | jq -e . >/dev/null 2>&1; then
              echo "❌ GitHub API request failed or returned invalid JSON"
              echo "Falling back to git tags..."
              # 使用 git tag 命令获取本地标签
              TAGS=( $(git tag --sort=-v:refname) )
          else
              # 检查是否返回错误信息
              if echo "$TAGS_JSON" | jq -e 'type == "object" and has("message")' >/dev/null 2>&1; then
                  echo "❌ GitHub API Error"
                  echo "Falling back to git tags..."
                  TAGS=( $(git tag --sort=-v:refname) )
              else
                  # 正常情况：提取标签
                  TAGS=( $(echo "$TAGS_JSON" | jq -r '.[].name' | sort -V) )
              fi
          fi

          # 找到上一个标签
          PREV_TAG=""
          for i in "${!TAGS[@]}"; do
              if [ "${TAGS[$i]}" = "$CURRENT_TAG" ]; then
                  if [ $i -gt 0 ]; then
                      PREV_TAG="${TAGS[$((i-1))]}"
                  fi
                  break
              fi
          done
          
          if [ -z "$PREV_TAG" ]; then
              echo "⚠️ Could not find previous tag, using first commit"
              PREV_TAG=$(git rev-list --max-parents=0 HEAD | head -1)
          fi

          echo "Previous tag: $PREV_TAG"

          # 使用默认模板生成发布说明
          DEFAULT_TEMPLATE=".github/prompt/default.md"
          if [ -f "$DEFAULT_TEMPLATE" ]; then
            echo "Using default template for release notes"
            # 读取默认模板并替换变量
            cat "$DEFAULT_TEMPLATE" > CHANGELOG.md
            sed -i "s/\$CURRENT_TAG/$CURRENT_TAG/g" CHANGELOG.md
            sed -i "s/\$PREV_TAG/$PREV_TAG/g" CHANGELOG.md
            sed -i "s/\${CURRENT_TAG}/$CURRENT_TAG/g" CHANGELOG.md
            sed -i "s/\${PREV_TAG}/$PREV_TAG/g" CHANGELOG.md
          else
            echo "⚠️ Default template file not found, using minimal template"
            echo "# $CURRENT_TAG\n\n## 更新\n- 修复了一些问题\n- 优化了一些功能\n\n**完整更新日志**: [${PREV_TAG}...${CURRENT_TAG}](https://github.com/TBeduCN/FastCode/compare/${PREV_TAG}...${CURRENT_TAG})" > CHANGELOG.md
          fi
          echo "=== generated release note ==="
          cat CHANGELOG.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/fastcode_*
          body_path: CHANGELOG.md
          draft: true